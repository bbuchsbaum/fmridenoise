% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/ndx_whitening.R
\name{ndx_ar2_whitening}
\alias{ndx_ar2_whitening}
\title{AR(2) Pre-whitening for fMRI Data}
\usage{
ndx_ar2_whitening(
  Y_data,
  X_design_full,
  Y_residuals_for_AR_fit,
  order = 2L,
  global_ar_on_design = TRUE,
  max_ar_failures_prop = 0.3
)
}
\arguments{
\item{Y_data}{A numeric matrix (timepoints x voxels) of fMRI data to be whitened.}

\item{X_design_full}{A numeric matrix (timepoints x regressors) representing the
full design matrix to be whitened.}

\item{Y_residuals_for_AR_fit}{A numeric matrix (timepoints x voxels) of residuals
used to estimate the AR(2) coefficients. This should typically be from a model
that accounts for task effects and other known structured noise components.}

\item{order}{Integer, the order of the AR model. Defaults to 2 for AR(2).}

\item{global_ar_on_design}{Logical, if TRUE (default), a global AR model (averaged from successful
voxel-wise fits) is used to whiten `X_design_full`. If FALSE, `X_design_full` is not whitened,
and users should handle its whitening if necessary for downstream voxel-wise modeling.}

\item{max_ar_failures_prop}{Numeric between 0 and 1 specifying the maximum
allowed proportion of voxels with failed or unstable AR fits. If the observed
proportion exceeds this threshold, whitening is skipped and a warning is
issued.}
}
\value{
A list containing:
  - `Y_whitened`: The AR(order)-whitened fMRI data (timepoints x voxels).
  - `X_whitened`: The AR(order)-whitened design matrix (timepoints x regressors). If `global_ar_on_design` is FALSE,
    this will be the original `X_design_full`.
  - `AR_coeffs_voxelwise`: A matrix (voxels x order) of the estimated voxel-wise AR coefficients.
    Stable coefficients are returned; unstable ones are set to zero. The first column corresponds to phi_1, the second to phi_2, etc.
  - `AR_coeffs_global`: A numeric vector of length `order` representing the global AR coefficients used for
    whitening `X_design_full` (if `global_ar_on_design` is TRUE). NULL otherwise.
  - `var_innovations_voxelwise`: A numeric vector (voxels) of the estimated voxel-wise innovation variances
    (i.e., variance of residuals after whitening). NA for voxels where AR fit failed.
  - `na_mask`: A logical vector of length `n_timepoints`. TRUE for the initial `order` rows that are NA in
    `Y_whitened` and `X_whitened` (if applicable), FALSE otherwise.
}
\description{
Estimates AR(2) model coefficients voxel-wise from provided residuals and applies
the whitening transformation to the fMRI data and the design matrix.
}
\details{
The AR(order) model for a time series `y_t` is: 
`y_t = phi_1 * y_{t-1} + ... + phi_order * y_{t-order} + e_t`, where `e_t` is white noise.
The whitened value `y*_t` (i.e., the estimate of `e_t`) is `y_t - phi_1 * y_{t-1} - ... - phi_order * y_{t-order}`.
This transformation is applied to `Y_data` using voxel-specific coefficients. Unstable AR coefficients are set to zero (no whitening for that voxel).
If `global_ar_on_design` is TRUE, `X_design_full` is whitened using averaged AR coefficients (from stable fits).
The first `order` rows of the whitened matrices will contain NAs due to the filter initialization (`method="convolution", sides=1`).
The `na_mask` in the output identifies these rows.
}
